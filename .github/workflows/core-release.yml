name: Release CloudXCore

on:
  push:
    tags:
      - 'v*-core'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

    steps:
      - name: 🗖 Checkout repo
        uses: actions/checkout@v4

      - name: 🛠 Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document

      - name: 📋 Debug Print CocoaPods version and env
        run: |
          pod --version
          pod env

      - name: 📋 Debug Show trunk config file
        run: |
          if [ -f ~/.cocoapods/trunk/me.json ]; then
            cat ~/.cocoapods/trunk/me.json
          else
            echo "No trunk config file found."
          fi

      - name: 📋 Debug pod trunk me
        run: pod trunk me || true

      - name: 🔢 Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          VERSION_NO_SUFFIX=${VERSION%-core}
          echo "version=$VERSION_NO_SUFFIX" >> $GITHUB_OUTPUT
          echo "full_version=$VERSION" >> $GITHUB_OUTPUT

      - name: 📝 Update podspec version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cd core
          sed -i '' "s/s\.version.*=.*/s.version          = '$VERSION'/" CloudXCore.podspec

      - name: 🧪 Validate podspec
        run: |
          cd core
          pod spec lint CloudXCore.podspec --allow-warnings --skip-import-validation --skip-tests --no-clean

      - name: 📤 Push podspec to CocoaPods trunk
        run: |
          mkdir -p ~/.cocoapods/trunk
          echo '{"trunk":{"token":"${{ secrets.COCOAPODS_TOKEN_NEW }}"}}' > ~/.cocoapods/trunk/me.json
          cd core

          for i in {1..5}; do
            pod trunk push CloudXCore.podspec --allow-warnings --skip-import-validation --skip-tests && break
            echo "Pod trunk push failed. Retrying in 30 seconds... ($i/5)"
            sleep 30
          done

      - name: 🧾 Check pod trunk push succeeded
        run: pod trunk info CloudXCore

      - name: 📊 Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Create release notes file
          cat > release_notes.md << EOF
          CloudXCore v$VERSION SDK release (source distribution)
          
          ## Installation
          
          ### CocoaPods
          Add to your Podfile: pod 'CloudXCore', '~> $VERSION'
          
          ### Swift Package Manager
          Add repository: https://github.com/cloudx-io/cloudx-ios
          
          This release provides source-based distribution for easier integration and debugging.
          EOF
          
          gh release create "$FULL_VERSION" \
            --title "CloudXCore v$VERSION" \
            --notes-file release_notes.md \
            --latest

      - name: 📌 Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: release-logs
          path: |
            *.log
