name: Release CloudXMetaAdapter

on:
  push:
    tags:
      - 'v*-meta'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

    steps:
      - name: 𝔠 Debug available Xcode versions
        run: ls -la /Applications/ | grep -i xcode

      - name: 𝔠 Switch to Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: 🗖 Checkout repo
        uses: actions/checkout@v4

      - name: 🤠 Clean build artifacts
        run: |
          rm -rf build
          rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: 🛠 Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document

      - name: 📋 Debug Print CocoaPods version and env
        run: |
          pod --version
          pod env

      - name: 📋 Debug Show trunk config file
        run: |
          if [ -f ~/.cocoapods/trunk/me.json ]; then
            cat ~/.cocoapods/trunk/me.json
          else
            echo "No trunk config file found."
          fi

      - name: 📋 Debug pod trunk me
        run: pod trunk me || true

      - name: 🔢 Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          VERSION_NO_SUFFIX=${VERSION%-meta}
          echo "version=$VERSION_NO_SUFFIX" >> $GITHUB_OUTPUT
          echo "full_version=$VERSION" >> $GITHUB_OUTPUT

      - name: 📀 Build static xcframework
        run: |
          cd adapter-meta
          bash build_frameworks.sh

      - name: 📦 Rename framework with version
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          mv CloudXMetaAdapter.xcframework.zip CloudXMetaAdapter-v$VERSION.xcframework.zip

      - name: 🔢 Compute SwiftPM checksum
        id: checksum
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          CHECKSUM=$(swift package compute-checksum CloudXMetaAdapter-v$VERSION.xcframework.zip)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: 📝 Update podspec and Package.swift
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Update podspec version
          sed -i '' "s/s\.version.*=.*/s.version = '$VERSION'/" CloudXMetaAdapter.podspec
          
          # Update root Package.swift version and checksum for CloudXMetaAdapter binary target
          cd ..
          sed -i '' "s|url: \".*CloudXMetaAdapter.*\",|url: \"https://github.com/cloudx-io/cloudx-ios/releases/download/v$FULL_VERSION/CloudXMetaAdapter-v$VERSION.xcframework.zip\",|" Package.swift
          sed -i '' "s|checksum: \".*\"|checksum: \"${{ steps.checksum.outputs.checksum }}\"|" Package.swift

      - name: 📊 Create GitHub release (step 1 - empty release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Create release notes file
          cat > release_notes.md << EOF
          CloudXMetaAdapter v$VERSION SDK release (static xcframework)
          
          ## Installation
          
          ### CocoaPods
          Add to your Podfile: pod 'CloudXMetaAdapter', '~> $VERSION'
          
          ### Swift Package Manager
          Add repository: https://github.com/cloudx-io/cloudx-ios
          
          ### Manual Installation
          Download CloudXMetaAdapter-v$VERSION.xcframework.zip from this release.
          
          ## SwiftPM Checksum
          ${{ steps.checksum.outputs.checksum }}
          EOF
          
          # Create empty release first (two-step process for better CDN propagation)
          gh release create "$FULL_VERSION" \
            --title "CloudXMetaAdapter v$VERSION" \
            --notes-file release_notes.md \
            --latest

      - name: 📦 Upload xcframework to release (step 2 - file upload)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Upload the xcframework file to the existing release
          gh release upload "$FULL_VERSION" \
            adapter-meta/CloudXMetaAdapter-v$VERSION.xcframework.zip

      - name: 💤 Wait for .xcframework.zip to be globally available
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          ZIP_URL="https://github.com/cloudx-io/cloudx-ios/releases/download/v$FULL_VERSION/CloudXMetaAdapter-v$VERSION.xcframework.zip"
          echo "Waiting for $ZIP_URL to be fully available..."

          # Two-step process should be faster, but still wait for CDN propagation
          for i in {1..40}; do
            STATUS=$(curl -s -L -w "%{http_code}" -o /dev/null "$ZIP_URL")
            if [ "$STATUS" = "200" ]; then
              echo "✅ File is now available (HTTP 200) after $i attempts."
              
              # Additional verification that file is truly downloadable
              if curl -fL --retry 3 --connect-timeout 10 --max-time 30 "$ZIP_URL" -o /dev/null; then
                echo "✅ File is confirmed downloadable."
                break
              else
                echo "⚠️  File returns 200 but not fully downloadable yet, continuing to wait..."
              fi
            fi
            echo "Waiting... ($i/40) — Current HTTP status: $STATUS"
            sleep 5
          done

          # Final verification
          if ! curl -fL --retry 3 --connect-timeout 10 --max-time 30 "$ZIP_URL" -o /dev/null; then
            echo "❌ .xcframework.zip did not become downloadable after 40 attempts (200 seconds)."
            exit 1
          fi

      - name: 📤 Push podspec to CocoaPods trunk
        run: |
          mkdir -p ~/.cocoapods/trunk
          echo '{"trunk":{"token":"${{ secrets.COCOAPODS_TRUNK_TOKEN }}"}}' > ~/.cocoapods/trunk/me.json
          cd adapter-meta

          for i in {1..5}; do
            pod trunk push CloudXMetaAdapter.podspec --allow-warnings --skip-import-validation --skip-tests && break
            echo "Pod trunk push failed. Retrying in 30 seconds... ($i/5)"
            sleep 30
          done

      - name: 🧾 Check pod trunk push succeeded
        run: pod trunk info CloudXMetaAdapter

      - name: 📌 Upload xcodebuild logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-logs
          path: |
            adapter-meta/xcodebuild-ios.log
            adapter-meta/xcodebuild-sim.log 