name: Release CloudXMetaAdapter

on:
  push:
    tags:
      - 'v*-meta'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

    steps:
      - name: ùî† Debug available Xcode versions
        run: ls -la /Applications/ | grep -i xcode

      - name: ùî† Switch to Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: üóñ Checkout repo
        uses: actions/checkout@v4

      - name: ü§† Clean build artifacts
        run: |
          rm -rf build
          rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: üõ† Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document

      - name: üìã Debug Print CocoaPods version and env
        run: |
          pod --version
          pod env

      - name: üìã Debug Show trunk config file
        run: |
          if [ -f ~/.cocoapods/trunk/me.json ]; then
            cat ~/.cocoapods/trunk/me.json
          else
            echo "No trunk config file found."
          fi

      - name: üìã Debug pod trunk me
        run: pod trunk me || true

      - name: üî¢ Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          VERSION_NO_SUFFIX=${VERSION%-meta}
          echo "version=$VERSION_NO_SUFFIX" >> $GITHUB_OUTPUT
          echo "full_version=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: üìÄ Build static xcframework
        run: |
          cd adapter-meta
          bash build_frameworks.sh

      - name: üì¶ Rename framework with version
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          mv CloudXMetaAdapter.xcframework.zip CloudXMetaAdapter-v$VERSION.xcframework.zip

      - name: üî¢ Compute SwiftPM checksum
        id: checksum
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          CHECKSUM=$(swift package compute-checksum CloudXMetaAdapter-v$VERSION.xcframework.zip)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: üìù Update podspec and Package.swift
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Update podspec version
          sed -i '' "s/s\.version.*=.*/s.version = '$VERSION'/" CloudXMetaAdapter.podspec
          
          # Update root Package.swift version and checksum for CloudXMetaAdapter binary target
          cd ..
          sed -i '' "s|url: \".*CloudXMetaAdapter.*\",|url: \"https://github.com/cloudx-io/cloudx-ios/releases/download/v$FULL_VERSION/CloudXMetaAdapter-v$VERSION.xcframework.zip\",|" Package.swift
          sed -i '' "s|checksum: \".*\"|checksum: \"${{ steps.checksum.outputs.checksum }}\"|" Package.swift

      - name: üìä Create GitHub release (step 1 - empty release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Create release notes file
          cat > release_notes.md << EOF
          CloudXMetaAdapter v$VERSION SDK release (static xcframework)
          
          ## Installation
          
          ### CocoaPods
          Add to your Podfile: pod 'CloudXMetaAdapter', '~> $VERSION'
          
          ### Swift Package Manager
          Add repository: https://github.com/cloudx-io/cloudx-ios
          
          ### Manual Installation
          Download CloudXMetaAdapter-v$VERSION.xcframework.zip from this release.
          
          ## SwiftPM Checksum
          ${{ steps.checksum.outputs.checksum }}
          EOF
          
          # Create empty release first (two-step process for better CDN propagation)
          gh release create "$FULL_VERSION" \
            --title "CloudXMetaAdapter v$VERSION" \
            --notes-file release_notes.md \
            --latest

      - name: üì¶ Upload xcframework to release (step 2 - file upload)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Upload the xcframework file to the existing release
          gh release upload "$FULL_VERSION" \
            adapter-meta/CloudXMetaAdapter-v$VERSION.xcframework.zip


      - name: üîç Debug file structure
        run: |
          echo "=== Repository structure ==="
          ls -la
          echo "=== Adapter-meta directory ==="
          ls -la adapter-meta/
          echo "=== License file check ==="
          if [ -f "adapter-meta/LICENSE" ]; then
            echo "‚úÖ LICENSE file found at adapter-meta/LICENSE"
            wc -l adapter-meta/LICENSE
          else
            echo "‚ùå LICENSE file NOT found at adapter-meta/LICENSE"
          fi

      - name: üß™ Validate podspec with detailed output
        run: |
          cd adapter-meta
          echo "=== Validating CloudXMetaAdapter.podspec ==="
          echo "Current directory: $(pwd)"
          echo "Podspec content:"
          cat CloudXMetaAdapter.podspec
          echo "=== Running podspec validation ==="
          pod spec lint CloudXMetaAdapter.podspec --allow-warnings --skip-import-validation --skip-tests --verbose || {
            echo "‚ùå Podspec validation failed"
            exit 1
          }

      - name: üîê Setup CocoaPods authentication
        run: |
          echo "=== Setting up CocoaPods authentication ==="
          
          # Clean any existing authentication
          rm -rf ~/.cocoapods/trunk
          
          # Create fresh authentication directory and config
          mkdir -p ~/.cocoapods/trunk
          echo '{"trunk":{"token":"${{ secrets.COCOAPODS_TOKEN_NEW }}"}}' > ~/.cocoapods/trunk/me.json
          
          # Verify authentication with retry mechanism
          echo "=== Verifying authentication ==="
          for i in {1..3}; do
            if pod trunk me; then
              echo "‚úÖ Authentication verified successfully"
              break
            else
              echo "‚ùå Authentication verification failed (attempt $i/3)"
              if [ $i -lt 3 ]; then
                echo "Waiting 15 seconds before retry..."
                sleep 15
                # Recreate auth file in case it was corrupted
                echo '{"trunk":{"token":"${{ secrets.COCOAPODS_TOKEN_NEW }}"}}' > ~/.cocoapods/trunk/me.json
              else
                echo "‚ùå Authentication setup failed after all retries"
                exit 1
              fi
            fi
          done

      - name: üì§ Push podspec to CocoaPods trunk
        run: |
          cd adapter-meta
          echo "=== Starting CocoaPods trunk push ==="
          echo "Current directory: $(pwd)"
          
          # Exponential backoff retry mechanism
          RETRY_COUNT=0
          MAX_RETRIES=6
          BASE_DELAY=30
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            DELAY=$((BASE_DELAY * RETRY_COUNT))
            
            echo "=== Attempt $RETRY_COUNT/$MAX_RETRIES ==="
            echo "Current authentication status:"
            pod trunk me || echo "‚ö†Ô∏è Authentication issue detected"
            
            if pod trunk push CloudXMetaAdapter.podspec --allow-warnings --skip-import-validation --skip-tests --verbose; then
              echo "‚úÖ Pod trunk push succeeded on attempt $RETRY_COUNT"
              break
            else
              echo "‚ùå Pod trunk push failed on attempt $RETRY_COUNT"
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Retrying in $DELAY seconds with exponential backoff..."
                sleep $DELAY
                
                # Refresh authentication for next attempt
                echo "Refreshing authentication..."
                echo '{"trunk":{"token":"${{ secrets.COCOAPODS_TOKEN_NEW }}"}}' > ~/.cocoapods/trunk/me.json
              else
                echo "‚ùå Pod trunk push failed after all retries"
                echo "=== Final debug information ==="
                echo "Working directory: $(pwd)"
                echo "Files in current directory:"
                ls -la
                echo "CocoaPods trunk config:"
                cat ~/.cocoapods/trunk/me.json || echo "No trunk config found"
                echo "Pod environment:"
                pod env
                exit 1
              fi
            fi
          done

      - name: üßæ Verify successful pod trunk push
        run: |
          echo "=== Verifying pod trunk push success ==="
          
          # Wait a moment for CocoaPods to process
          sleep 10
          
          # Verify the pod is available
          if pod trunk info CloudXMetaAdapter; then
            echo "‚úÖ Pod trunk push verification successful"
            
            # Extract and display the latest version
            LATEST_VERSION=$(pod trunk info CloudXMetaAdapter | grep -E "^\s*-\s*[0-9]" | head -1 | sed 's/^\s*-\s*//')
            echo "Latest published version: $LATEST_VERSION"
            
            # Verify it matches our expected version
            EXPECTED_VERSION="${{ steps.version.outputs.version }}"
            if [[ "$LATEST_VERSION" == "$EXPECTED_VERSION" ]]; then
              echo "‚úÖ Version verification successful: $LATEST_VERSION matches expected $EXPECTED_VERSION"
            else
              echo "‚ö†Ô∏è Version mismatch: Latest=$LATEST_VERSION, Expected=$EXPECTED_VERSION"
              echo "This might be expected if the version was already published"
            fi
          else
            echo "‚ùå Pod trunk info failed - pod may not be properly published"
            exit 1
          fi

      - name: üìå Upload xcodebuild logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-logs
          path: |
            adapter-meta/xcodebuild-ios.log
            adapter-meta/xcodebuild-sim.log 