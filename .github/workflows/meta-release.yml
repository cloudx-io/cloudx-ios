name: Release CloudXMetaAdapter

on:
  push:
    tags:
      - 'v*-meta'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

    steps:
      - name: ùî† Debug available Xcode versions
        run: ls -la /Applications/ | grep -i xcode

      - name: ùî† Switch to Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: üóñ Checkout repo
        uses: actions/checkout@v4

      - name: ü§† Clean build artifacts
        run: |
          rm -rf build
          rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: üõ† Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document

      - name: üìã Debug Print CocoaPods version and env
        run: |
          pod --version
          pod env

      - name: üìã Debug Show trunk config file
        run: |
          if [ -f ~/.cocoapods/trunk/me.json ]; then
            cat ~/.cocoapods/trunk/me.json
          else
            echo "No trunk config file found."
          fi

      - name: üìã Debug pod trunk me
        run: pod trunk me || true

      - name: üî¢ Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          VERSION_NO_SUFFIX=${VERSION%-meta}
          echo "version=$VERSION_NO_SUFFIX" >> $GITHUB_OUTPUT
          echo "full_version=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: üìÄ Build static xcframework
        run: |
          cd adapter-meta
          bash build_frameworks.sh

      - name: üì¶ Rename framework with version
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          mv CloudXMetaAdapter.xcframework.zip CloudXMetaAdapter-v$VERSION.xcframework.zip

      - name: üî¢ Compute SwiftPM checksum
        id: checksum
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          CHECKSUM=$(swift package compute-checksum CloudXMetaAdapter-v$VERSION.xcframework.zip)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: üìù Update podspec and Package.swift
        run: |
          cd adapter-meta
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Update podspec version
          sed -i '' "s/s\.version.*=.*/s.version = '$VERSION'/" CloudXMetaAdapter.podspec
          
          # Update root Package.swift version and checksum for CloudXMetaAdapter binary target
          cd ..
          sed -i '' "s|url: \".*CloudXMetaAdapter.*\",|url: \"https://github.com/cloudx-io/cloudx-ios/releases/download/v$FULL_VERSION/CloudXMetaAdapter-v$VERSION.xcframework.zip\",|" Package.swift
          sed -i '' "s|checksum: \".*\"|checksum: \"${{ steps.checksum.outputs.checksum }}\"|" Package.swift

      - name: üìä Create GitHub release (step 1 - empty release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Create release notes file
          cat > release_notes.md << EOF
          CloudXMetaAdapter v$VERSION SDK release (static xcframework)
          
          ## Installation
          
          ### CocoaPods
          Add to your Podfile: pod 'CloudXMetaAdapter', '~> $VERSION'
          
          ### Swift Package Manager
          Add repository: https://github.com/cloudx-io/cloudx-ios
          
          ### Manual Installation
          Download CloudXMetaAdapter-v$VERSION.xcframework.zip from this release.
          
          ## SwiftPM Checksum
          ${{ steps.checksum.outputs.checksum }}
          EOF
          
          # Create empty release first (two-step process for better CDN propagation)
          gh release create "$FULL_VERSION" \
            --title "CloudXMetaAdapter v$VERSION" \
            --notes-file release_notes.md \
            --latest

      - name: üì¶ Upload xcframework to release (step 2 - file upload)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Upload the xcframework file to the existing release
          gh release upload "$FULL_VERSION" \
            adapter-meta/CloudXMetaAdapter-v$VERSION.xcframework.zip


      - name: üîç Debug file structure and authentication
        run: |
          echo "=== Repository structure ==="
          ls -la
          echo "=== Adapter-meta directory ==="
          ls -la adapter-meta/
          echo "=== License file check ==="
          if [ -f "adapter-meta/LICENSE" ]; then
            echo "‚úÖ LICENSE file found at adapter-meta/LICENSE"
            wc -l adapter-meta/LICENSE
          else
            echo "‚ùå LICENSE file NOT found at adapter-meta/LICENSE"
          fi
          echo "=== CocoaPods authentication setup ==="
          mkdir -p ~/.cocoapods/trunk
          echo '{"trunk":{"token":"${{ secrets.COCOAPODS_TOKEN_NEW }}"}}' > ~/.cocoapods/trunk/me.json
          echo "Token file created. Testing authentication..."
          pod trunk me || echo "‚ö†Ô∏è Authentication test failed, but continuing..."

      - name: üß™ Validate podspec with detailed output
        run: |
          cd adapter-meta
          echo "=== Validating CloudXMetaAdapter.podspec ==="
          echo "Current directory: $(pwd)"
          echo "Podspec content:"
          cat CloudXMetaAdapter.podspec
          echo "=== Running podspec validation ==="
          pod spec lint CloudXMetaAdapter.podspec --allow-warnings --skip-import-validation --skip-tests --verbose || {
            echo "‚ùå Podspec validation failed"
            exit 1
          }

      - name: üì§ Push podspec to CocoaPods trunk
        run: |
          cd adapter-meta
          echo "=== Starting CocoaPods trunk push ==="
          echo "Current directory: $(pwd)"
          echo "Authentication status:"
          pod trunk me || echo "‚ö†Ô∏è Authentication issue detected"

          for i in {1..5}; do
            echo "=== Attempt $i/5 ==="
            if pod trunk push CloudXMetaAdapter.podspec --allow-warnings --skip-import-validation --skip-tests --verbose; then
              echo "‚úÖ Pod trunk push succeeded on attempt $i"
              break
            else
              echo "‚ùå Pod trunk push failed on attempt $i"
              if [ $i -lt 5 ]; then
                echo "Retrying in 30 seconds..."
                sleep 30
              fi
            fi
          done
          
          # Final verification
          echo "=== Final verification ==="
          pod trunk push CloudXMetaAdapter.podspec --allow-warnings --skip-import-validation --skip-tests || {
            echo "‚ùå Pod trunk push failed after all retries"
            echo "=== Debug information ==="
            echo "Working directory: $(pwd)"
            echo "Files in current directory:"
            ls -la
            echo "CocoaPods trunk config:"
            cat ~/.cocoapods/trunk/me.json || echo "No trunk config found"
            exit 1
          }

      - name: üßæ Check pod trunk push succeeded
        run: pod trunk info CloudXMetaAdapter

      - name: üìå Upload xcodebuild logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-logs
          path: |
            adapter-meta/xcodebuild-ios.log
            adapter-meta/xcodebuild-sim.log 